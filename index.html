<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EasyBid — Contractor Bid Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; }
    h2 { margin: 24px 0 8px; }
    input, textarea, button, select { font: inherit; padding: 6px 8px; }
    input, textarea, select { border: 1px solid #ccc; border-radius: 6px; width: 100%; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; vertical-align: top; }
    th { background: #fafafa; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top: 12px; }
    .totals { border:1px solid #eee; border-radius: 8px; padding: 12px; background:#fafafa; max-width: 420px;}
    .right { text-align:right; white-space:nowrap; }
    .muted { color:#666; font-size: 12px; }
    .nowrap { white-space: nowrap; }
    .status { background:#f6f8fa; border:1px solid #e5e7eb; padding:8px 12px; border-radius:8px; margin:12px 0; font-size:12px; color:#444;}
    @media print {.no-print { display:none !important; } body { margin: 0.5in; } th { -webkit-print-color-adjust: exact; print-color-adjust: exact; }}
    label > span { font-size: 12px; color:#555; display:block; margin-bottom:4px; }

    /* Toast message styling */
    .toast {
      visibility: hidden;
      min-width: 200px;
      background: #333;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 10px 16px;
      position: fixed;
      z-index: 1000;
      left: 50%;
      bottom: 40px;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.4s, bottom 0.4s;
      font-size: 14px;
    }
    .toast.show {
      visibility: visible;
      opacity: 1;
      bottom: 60px;
    }
  </style>
</head>
<body>
  <h1>EasyBid — Contractor Bid Tool</h1>
  <div class="muted">Add your items, set markup, send to Google Sheets, and generate a Google Doc proposal. You can also save/load a draft locally.</div>

  <div id="urlStatus" class="status no-print">Web App URL: <em>(not set)</em></div>

  <h2>Company</h2>
  <div class="grid-2">
    <label><span>Company name</span><input id="coName" value="Moore Builder & Sons" /></label>
    <label><span>Phone</span><input id="coPhone" value="505-252-0930" /></label>
  </div>
  <div class="grid-2">
    <label><span>Email</span><input id="coEmail" value="moorebuilderandsons@gmail.com" /></label>
    <label><span>License #</span><input id="coLicense" value="Pending" /></label>
  </div>
  <label><span>Address</span><input id="coAddress" value="Placitas, NM 87043" style="margin-bottom:8px;" /></label>

  <h2>Client</h2>
  <div class="grid-2">
    <label><span>Client name</span><input id="clientName" /></label>
    <label><span>Client email</span><input id="clientEmail" /></label>
  </div>
  <div class="grid-2">
    <label><span>Client phone</span><input id="clientPhone" /></label>
    <label><span>Client address</span><input id="clientAddress" /></label>
  </div>

  <h2>Project</h2>
  <div class="grid-2">
    <label><span>Project title</span><input id="projTitle" value="Untitled Bid" /></label>
    <label><span>Reference #</span><input id="projRef" /></label>
  </div>
  <div class="grid-2">
    <label><span>Site address</span><input id="projSite" /></label>
    <label><span>Valid (days)</span><input id="projValid" type="number" value="30" /></label>
  </div>

  <h2>Line Items</h2>
  <table id="itemsTable">
    <thead>
      <tr>
        <th style="width:24%">Name</th>
        <th class="nowrap">Qty</th>
        <th class="nowrap">Unit</th>
        <th class="nowrap">Unit Cost</th>
        <th class="nowrap">Labor Hrs</th>
        <th class="nowrap">Labor Rate</th>
        <th class="right nowrap">Material $</th>
        <th class="right nowrap">Labor $</th>
        <th class="no-print"></th>
      </tr>
    </thead>
    <tbody id="itemsBody"></tbody>
  </table>
  <div class="actions no-print">
    <button id="addLineBtn">Add line</button>
    <button id="clearBtn">Clear all</button>
  </div>

  <h2>Markup</h2>
  <div class="grid-4" style="max-width:900px">
    <label><span>Profit %</span><input id="profitPct" type="number" inputmode="decimal" value="20" /></label>
    <label><span>Tax %</span><input id="taxPct" type="number" inputmode="decimal" value="7.625" /></label>
    <label><span>Tax $ (auto)</span><input id="taxDollars" disabled /></label>
    <label><span>Contingency %</span><input id="contingencyPct" type="number" inputmode="decimal" value="5" /></label>
  </div>

  <h2>Notes</h2>
  <textarea id="notes" rows="4"></textarea>

  <h2>Terms</h2>
  <textarea id="terms" rows="3">Payment terms: 50% deposit to schedule, balance upon substantial completion. Prices valid for 30 days.</textarea>

  <h2>Totals</h2>
  <div class="totals">
    <div>Materials: <span id="matTotal" class="right"></span></div>
    <div>Labor: <span id="labTotal" class="right"></span></div>
    <div>Base: <span id="baseTotal" class="right"></span></div>
    <div>Contingency: <span id="contTotal" class="right"></span></div>
    <div>Profit: <span id="profitTotal" class="right"></span></div>
    <div>Tax: <span id="taxTotal" class="right"></span></div>
    <div style="border-top:1px solid #ddd; margin:8px 0;"></div>
    <div><strong>Total: <span id="grandTotal" class="right"></span></strong></div>
  </div>

  <div class="actions no-print" style="margin-top:16px;">
    <button id="saveDraftBtn">Save Draft</button>
    <button id="loadDraftBtn">Load Draft</button>
    <button id="newDraftBtn">New / Clear</button>
    <button id="sendToSheetsBtn">Send to Google Sheets</button>
    <button id="createDocBtn">Create Google Doc Proposal</button>
    <button id="printBtn">Print / Save PDF</button>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxGoKZj6FSdeonBad9o1VOCLTxH_eKKaWoxSSVj38WGLMZn-yTybIqWqNxIlpCPUeo9/exec";

    function showToast(msg, timeout = 2000) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.className = "toast show";
      setTimeout(() => { toast.className = toast.className.replace("show", ""); }, timeout);
    }

    (function showCurrentUrl(){
      const el = document.getElementById("urlStatus");
      el.innerHTML = "Web App URL: <code>" + (WEB_APP_URL || "(not set)") + "</code>";
      console.log("WEB_APP_URL =", WEB_APP_URL);
    })();

    function isValidAppsScriptUrl(u){ return typeof u==="string" && /^https:\\/\\/script\\.google\\.com\\/macros\\/s\\/[^\\/]+\\/exec$/.test(u.trim()); }
    const $ = (id)=>document.getElementById(id);
    const currency=(n)=>(isFinite(n)?n:0).toLocaleString(undefined,{style:"currency",currency:"USD"});
    const num=(v)=>(v===""||v==null?0:Number(v));

    let items=[];
    function defaultItem(){return{id:Math.random().toString(36).slice(2),name:\"\",qty:\"\",unit:\"ea\",unitCost:\"\",laborHours:\"\",laborRate:\"70\"};}
    function addRow(it=defaultItem()){items.push(it);render();}
    function removeRow(id){items=items.filter(x=>x.id!==id);render();}

    function computeTotals(){
      const material=items.reduce((s,it)=>s+num(it.qty)*num(it.unitCost),0);
      const labor=items.reduce((s,it)=>s+num(it.laborHours)*num(it.laborRate),0);
      const base=material+labor;
      const cPct=num($(\"contingencyPct\").value),pPct=num($(\"profitPct\").value),tPct=num($(\"taxPct\").value);
      const cont=(cPct/100)*base,prof=(pPct/100)*(base+cont),sub=base+cont+prof,tax=(tPct/100)*sub,total=sub+tax;
      return{material,labor,base,contingency:cont,profit:prof,subtotal:sub,tax,total};
    }
    function updateTotalsUI(){
      const t=computeTotals();
      $(\"matTotal\").textContent=currency(t.material);
      $(\"labTotal\").textContent=currency(t.labor);
      $(\"baseTotal\").textContent=currency(t.base);
      $(\"contTotal\").textContent=currency(t.contingency);
      $(\"profitTotal\").textContent=currency(t.profit);
      $(\"taxTotal\").textContent=currency(t.tax);
      $(\"taxDollars\").value=currency(t.tax);
      $(\"grandTotal\").textContent=currency(t.total);
    }

    function render(){
      const tbody=$(\"itemsBody\");tbody.innerHTML=\"\";
      items.forEach(it=>{
        const tr=document.createElement(\"tr\");
        const tdMat=document.createElement(\"td\");tdMat.className=\"right\";
        const tdLab=document.createElement(\"td\");tdLab.className=\"right\";
        const update=()=>{tdMat.textContent=currency(num(it.qty)*num(it.unitCost));tdLab.textContent=currency(num(it.laborHours)*num(it.laborRate));};
        const cell=(prop,opts={})=>{const td=document.createElement(\"td\"),inp=document.createElement(\"input\");Object.assign(inp,opts);inp.value=it[prop]||\"\";inp.oninput=e=>{it[prop]=e.target.value;update();updateTotalsUI();};td.appendChild(inp);return td;};
        const del=document.createElement(\"td\"),btn=document.createElement(\"button\");btn.textContent=\"✕\";btn.onclick=()=>removeRow(it.id);del.className=\"no-print\";del.appendChild(btn);
        update();[cell(\"name\"),cell(\"qty\",{type:\"number\",step:\"any\"}),cell(\"unit\"),cell(\"unitCost\",{type:\"number\",step:\"any\"}),cell(\"laborHours\",{type:\"number\",step:\"any\"}),cell(\"laborRate\",{type:\"number\",step:\"any\"}),tdMat,tdLab,del].forEach(td=>tr.appendChild(td));tbody.appendChild(tr);
      });
      updateTotalsUI();
    }

    const DRAFT_KEY=\"easybid_draft_v3\";
    function saveDraft(){localStorage.setItem(DRAFT_KEY,JSON.stringify({company:{name:$(\"coName\").value,phone:$(\"coPhone\").value,email:$(\"coEmail\").value,license:$(\"coLicense\").value,address:$(\"coAddress\").value},client:{name:$(\"clientName\").value,email:$(\"clientEmail\").value,phone:$(\"clientPhone\").value,address:$(\"clientAddress\").value},project:{title:$(\"projTitle\").value,ref:$(\"projRef\").value,site:$(\"projSite\").value,validDays:$(\"projValid\").value},notes:$(\"notes\").value,terms:$(\"terms\").value,items}));showToast(\"Draft saved ✅\");}
    function loadDraft(){try{const d=JSON.parse(localStorage.getItem(DRAFT_KEY)||\"{}\");if(!d.items)return showToast(\"No saved draft ❌\");Object.assign($(\"coName\"),{value:d.company?.name||\"\"});Object.assign($(\"clientName\"),{value:d.client?.name||\"\"});Object.assign($(\"projTitle\"),{value:d.project?.title||\"\"});items=d.items||[];if(!items.length)items.push(defaultItem());render();showToast(\"Draft loaded ✅\");}catch{showToast(\"Could not load draft ❌\");}}
    function newDraft(){items=[];addRow();$(\"notes\").value=\"\";$(\"terms\").value=\"Payment terms: 50% deposit to schedule, balance upon substantial completion. Prices valid for 30 days.\";showToast(\"New draft ready\");}

    function sendToGoogleSheet(row){if(!isValidAppsScriptUrl(WEB_APP_URL))return showToast(\"Bad /exec URL ❌\");const payload=JSON.stringify({row});try{if(navigator.sendBeacon){navigator.sendBeacon(WEB_APP_URL,new Blob([payload],{type:\"text/plain;charset=UTF-8\"}));}else{fetch(WEB_APP_URL,{method:\"POST\",mode:\"no-cors\",body:payload});}showToast(\"Sent to Sheets ✅\");}catch{showToast(\"Send failed ❌\");}}

    async function createDocAction(){if(!isValidAppsScriptUrl(WEB_APP_URL))return showToast(\"Bad /exec URL ❌\");const payload=JSON.stringify({action:\"create_proposal\",proposal:buildProposal(),trackerRow:buildTrackerRow()});try{const r=await fetch(WEB_APP_URL,{method:\"POST\",body:payload});const t=await r.text();const j=JSON.parse(t||\"{}\");if(j.ok&&j.docUrl){window.open(j.docUrl,\"_blank\");showToast(\"Google Doc created ✅\");}else showToast(\"Doc creation failed ❌\");}catch{showToast(\"Could not reach Apps Script ❌\");}}

    function buildTrackerRow(){const t=computeTotals();return[new Date().toISOString(),$(\"projTitle\").value,$(\"clientName\").value,$(\"clientEmail\").value,$(\"clientPhone\").value,$(\"projSite\").value,$(\"projRef\").value,$(\"projValid\").value||30,t.material.toFixed(2),t.labor.toFixed(2),t.base.toFixed(2),0,\"0.00\",Number($(\"contingencyPct\").value||0),t.contingency.toFixed(2),Number($(\"profitPct\").value||0),t.profit.toFixed(2),Number($(\"taxPct\").value||0),t.tax.toFixed(2),t.total.toFixed(2),items.length];}
    function buildProposal(){const t=computeTotals();return{company:{name:$(\"coName\").value,phone:$(\"coPhone\").value,email:$(\"coEmail\").value,address:$(\"coAddress\").value,license:$(\"coLicense\").value},client:{name:$(\"clientName\").value,email:$(\"clientEmail\").value,phone:$(\"clientPhone\").value,address:$(\"clientAddress\").value},project:{title:$(\"projTitle\").value,site:$(\"projSite\").value,ref:$(\"projRef\").value,validDays:$(\"projValid\").value||30,notes:$(\"notes\").value,terms:$(\"terms\").value},items:items.map(it=>({name:it.name||\"\"})),totals:{subtotal:t.subtotal,tax:t.tax,total:t.total}};}

    $(\"addLineBtn\").onclick=()=>addRow();
    $(\"clearBtn\").onclick=()=>{items=[];addRow();};
    $(\"sendToSheetsBtn\").onclick=()=>{const row=buildTrackerRow();sendToGoogleSheet(row);};
    $(\"createDocBtn\").onclick=createDocAction;
    $(\"printBtn\").onclick=()=>window.print();
    $(\"saveDraftBtn\").onclick=saveDraft;
    $(\"loadDraftBtn\").onclick=loadDraft;
    $(\"newDraftBtn\").onclick=newDraft;
    [\"profitPct\",\"taxPct\",\"contingencyPct\"].forEach(id=>{$(id).addEventListener(\"input\",updateTotalsUI);$(id).addEventListener(\"change\",updateTotalsUI);});
    addRow();
  </script>
</body>
</html>
