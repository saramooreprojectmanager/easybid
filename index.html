<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EasyBid — Contractor Bid Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; }
    h2 { margin: 24px 0 8px; }
    input, textarea, button, select { font: inherit; padding: 6px 8px; }
    input, textarea, select { border: 1px solid #ccc; border-radius: 6px; width: 100%; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; vertical-align: top; }
    th { background: #fafafa; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top: 12px; }
    .totals { border:1px solid #eee; border-radius: 8px; padding: 12px; background:#fafafa; max-width: 460px;}
    .right { text-align:right; white-space:nowrap; }
    .muted { color:#666; font-size: 12px; }
    .nowrap { white-space: nowrap; }
    .status { background:#f6f8fa; border:1px solid #e5e7eb; padding:8px 12px; border-radius:8px; margin:12px 0; font-size:12px; color:#444;}
    @media print {.no-print { display:none !important; } body { margin: 0.5in; } th { -webkit-print-color-adjust: exact; print-color-adjust: exact; }}
    label > span { font-size: 12px; color:#555; display:block; margin-bottom:4px; }
  </style>
</head>
<body>
  <h1>EasyBid — Contractor Bid Tool</h1>
  <div class="muted">Create a bid, save with a BID_ID, recall later for approval → invoice. Send to Google Sheets or create a Google Doc proposal.</div>

  <div id="urlStatus" class="status no-print">Web App URL: <em>(not set)</em></div>

  <h2>Company</h2>
  <div class="grid-2">
    <label><span>Company name</span><input id="coName" value="Moore Builder & Sons" /></label>
    <label><span>Phone</span><input id="coPhone" value="505-252-0930" /></label>
  </div>
  <div class="grid-2">
    <label><span>Email</span><input id="coEmail" value="moorebuilderandsons@gmail.com" /></label>
    <label><span>Address</span><input id="coAddress" value="Placitas, NM 87043" /></label>
  </div>

  <h2>Client</h2>
  <div class="grid-2">
    <label><span>Client name</span><input id="clientName" /></label>
    <label><span>Client email</span><input id="clientEmail" /></label>
  </div>
  <div class="grid-2">
    <label><span>Client phone</span><input id="clientPhone" /></label>
    <label><span>Client address</span><input id="clientAddress" /></label>
  </div>

  <h2>Project</h2>
  <div class="grid-2">
    <label><span>Project title</span><input id="projTitle" value="Untitled Bid" /></label>
    <label><span>Reference #</span><input id="projRef" /></label>
  </div>
  <div class="grid-2">
    <label><span>Site address</span><input id="projSite" /></label>
    <label><span>Valid (days)</span><input id="projValid" type="number" value="30" /></label>
  </div>

  <h2>Line Items</h2>
  <table id="itemsTable">
    <thead>
      <tr>
        <th style="width:24%">Name</th>
        <th class="nowrap">Qty</th>
        <th class="nowrap">Unit</th>
        <th class="nowrap">Unit Cost</th>
        <th class="nowrap">Labor Hrs</th>
        <th class="nowrap">Labor Rate</th>
        <th class="right nowrap">Material $</th>
        <th class="right nowrap">Labor $</th>
        <th class="no-print"></th>
      </tr>
    </thead>
    <tbody id="itemsBody"></tbody>
  </table>
  <div class="actions no-print">
    <button id="addLineBtn">Add line</button>
    <button id="clearBtn">Clear all</button>
  </div>

  <h2>Markup</h2>
  <div class="grid-4" style="max-width:900px">
    <label><span>Profit %</span><input id="profitPct" type="number" inputmode="decimal" value="20" /></label>
    <label><span>Tax %</span><input id="taxPct" type="number" inputmode="decimal" value="7.625" /></label>
    <label><span>Tax $ (auto)</span><input id="taxDollars" disabled /></label>
    <label><span>Contingency %</span><input id="contingencyPct" type="number" inputmode="decimal" value="5" /></label>
  </div>

  <h2>Notes</h2>
  <textarea id="notes" rows="4"></textarea>

  <h2>Terms</h2>
  <textarea id="terms" rows="3">Payment terms: 50% deposit to schedule, balance upon substantial completion. Prices valid for 30 days.</textarea>

  <h2>Totals</h2>
  <div class="totals">
    <div>Materials: <span id="matTotal" class="right"></span></div>
    <div>Labor: <span id="labTotal" class="right"></span></div>
    <div>Base: <span id="baseTotal" class="right"></span></div>
    <div>Contingency: <span id="contTotal" class="right"></span></div>
    <div>Profit: <span id="profitTotal" class="right"></span></div>
    <div>Tax: <span id="taxTotal" class="right"></span></div>
    <div style="border-top:1px solid #ddd; margin:8px 0;"></div>
    <div><strong>Total: <span id="grandTotal" class="right"></span></strong></div>
  </div>

  <h2 class="no-print">Workflow</h2>
  <div class="actions no-print">
    <button id="saveBidBtn">Save Bid (get BID_ID)</button>
    <input id="loadBidId" placeholder="Enter BID_ID e.g., BID-20250912-1234" style="min-width:320px"/>
    <button id="loadBidBtn">Load Bid</button>
    <button id="approveBidBtn">Approve → Create Invoice</button>
  </div>

  <div class="actions no-print" style="margin-top:12px;">
    <button id="sendToSheetsBtn">Send to Google Sheets</button>
    <button id="createDocBtn">Create Google Doc Proposal</button>
    <button id="printBtn">Print / Save PDF</button>
  </div>

  <!-- Recent Bids Panel -->
  <div class="no-print" style="margin-top:16px; border:1px solid #eee; border-radius:8px; padding:12px;">
    <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
      <strong>Recent Bids</strong>
      <button id="refreshBidsBtn">Refresh</button>
      <span class="muted">Click a row to load it</span>
    </div>
    <div id="bidsList" class="muted">No data yet.</div>
  </div>

  <script>
    // ===========================
    // 1) PASTE YOUR WEB APP URL HERE (must end with /exec)
    // ===========================
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwXxAnrMSd7-w6BCokMWF087URRhAIicGR1mIndWJjRBfog7TGRz0ojv_0LttbhyGFv/exec";

    (function showUrl(){
      const el = document.getElementById("urlStatus");
      el.innerHTML = "Web App URL: <code>" + (WEB_APP_URL || "(not set)") + "</code>";
      console.log("WEB_APP_URL =", WEB_APP_URL);
    })();

    // ------- Utilities -------
    const $ = (id) => document.getElementById(id);
    const currency = (n) => (isFinite(n) ? n : 0).toLocaleString(undefined, { style: "currency", currency: "USD" });
    const num = (v) => (v === "" || v == null ? 0 : Number(v));

    // ------- Items State -------
    let items = [];
    function defaultItem() { return { id: Math.random().toString(36).slice(2), name: "", qty: "", unit: "ea", unitCost: "", laborHours: "", laborRate: "70" }; }
    function addRow(it = defaultItem()) { items.push(it); render(); }
    function removeRow(id) { items = items.filter((x) => x.id !== id); render(); }

    // ------- Calculations -------
    function computeTotals() {
      const material = items.reduce((s, it) => s + num(it.qty) * num(it.unitCost), 0);
      const labor    = items.reduce((s, it) => s + num(it.laborHours) * num(it.laborRate), 0);
      const base     = material + labor;
      const contingencyPct = num($("contingencyPct").value);
      const profitPct      = num($("profitPct").value);
      const taxPct         = num($("taxPct").value);
      const contingency = (contingencyPct / 100) * base;
      const profit      = (profitPct  / 100) * (base + contingency);
      const taxable     = base + contingency + profit;    // Subtotal
      const tax         = (taxPct   / 100) * taxable;
      const total       = taxable + tax;
      return { material, labor, base, contingency, profit, subtotal: taxable, tax, total };
    }
    function updateTotalsUI() {
      const t = computeTotals();
      $("matTotal").textContent    = currency(t.material);
      $("labTotal").textContent    = currency(t.labor);
      $("baseTotal").textContent   = currency(t.base);
      $("contTotal").textContent   = currency(t.contingency);
      $("profitTotal").textContent = currency(t.profit);
      $("taxTotal").textContent    = currency(t.tax);
      $("taxDollars").value        = currency(t.tax);
      $("grandTotal").textContent  = currency(t.total);
    }

    // ------- Render (stable inputs) -------
    function render() {
      const tbody = $("itemsBody"); tbody.innerHTML = "";
      items.forEach((it) => {
        const tr = document.createElement("tr");

        const tdMat = document.createElement("td"); tdMat.className = "right";
        const tdLab = document.createElement("td"); tdLab.className = "right";
        const updateRowComputed = () => {
          tdMat.textContent = currency(num(it.qty) * num(it.unitCost));
          tdLab.textContent = currency(num(it.laborHours) * num(it.laborRate));
        };

        const makeCellInput = (prop, opts = {}) => {
          const td = document.createElement("td");
          const input = document.createElement("input");
          if (opts.type) input.type = opts.type;
          if (opts.inputmode) input.setAttribute("inputmode", opts.inputmode);
          if (opts.step) input.setAttribute("step", opts.step);
          input.value = it[prop] ?? "";
          input.oninput = (e) => { it[prop] = e.target.value; updateRowComputed(); updateTotalsUI(); };
          td.appendChild(input);
          return td;
        };

        const tdName     = makeCellInput("name");
        const tdQty      = makeCellInput("qty",        { type: "number", inputmode: "decimal", step: "any" });
        const tdUnit     = makeCellInput("unit");
        const tdUnitCost = makeCellInput("unitCost",   { type: "number", inputmode: "decimal", step: "any" });
        const tdLaborH   = makeCellInput("laborHours", { type: "number", inputmode: "decimal", step: "any" });
        const tdLaborR   = makeCellInput("laborRate",  { type: "number", inputmode: "decimal", step: "any" });

        const tdDel = document.createElement("td"); tdDel.className = "no-print";
        const delBtn = document.createElement("button"); delBtn.textContent = "✕"; delBtn.onclick = () => removeRow(it.id);
        tdDel.appendChild(delBtn);

        updateRowComputed();
        [tdName, tdQty, tdUnit, tdUnitCost, tdLaborH, tdLaborR, tdMat, tdLab, tdDel].forEach(td => tr.appendChild(td));
        tbody.appendChild(tr);
      });
      updateTotalsUI();
    }

    // ------- Tracker row (for Sheets logging) -------
    function buildTrackerRow() {
      const t = computeTotals();
      return [
        new Date().toISOString(),
        $("projTitle").value, $("clientName").value, $("clientEmail").value, $("clientPhone").value,
        $("projSite").value, $("projRef").value, $("projValid").value || 30,
        t.material.toFixed(2), t.labor.toFixed(2), t.base.toFixed(2),
        0, "0.00",
        Number($("contingencyPct").value || 0), t.contingency.toFixed(2),
        Number($("profitPct").value || 0), t.profit.toFixed(2),
        Number($("taxPct").value || 0), t.tax.toFixed(2),
        t.total.toFixed(2), items.length
      ];
    }

    // ------- Build a BID object (FULL items) -------
    function buildBidFromForm() {
      const t = computeTotals();
      return {
        company: { name: $("coName").value, phone: $("coPhone").value, email: $("coEmail").value, address: $("coAddress").value },
        client:  { name: $("clientName").value, email: $("clientEmail").value, phone: $("clientPhone").value, address: $("clientAddress").value },
        project: { title: $("projTitle").value, site: $("projSite").value, ref: $("projRef").value, validDays: $("projValid").value || 30, notes: $("notes").value, terms: $("terms").value },
        items: items.map(it => ({
          name: it.name || "",
          qty: Number(it.qty || 0),
          unit: it.unit || "ea",
          unitCost: Number(it.unitCost || 0),
          laborHours: Number(it.laborHours || 0),
          laborRate: Number(it.laborRate || 65),
        })),
        totals: { subtotal: t.subtotal, tax: t.tax, total: t.total }
      };
    }

    function BID_ITEMS_HEADERS() {
  return ["BID_ID","Line #","Name","Qty","Unit","Unit Cost","Labor Hours","Labor Rate"];
}

    // ------- Post helper (HTTPS JSON; local fallbacks) -------
    async function postJson(payload){
      // Prefer full JSON when hosted (https)
      if (location.protocol.startsWith("http")) {
        const res = await fetch(WEB_APP_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
        return await res.json();
      }
      // Local file fallbacks (no readable response)
      const body = JSON.stringify(payload);
      if (navigator.sendBeacon) {
        const blob = new Blob([body], { type:"text/plain;charset=UTF-8" });
        navigator.sendBeacon(WEB_APP_URL, blob);
        return { ok:true, _offline:true };
      }
      await fetch(WEB_APP_URL, { method:"POST", mode:"no-cors", headers:{ "Content-Type":"text/plain;charset=UTF-8" }, body });
      return { ok:true, _offline:true };
    }

    // ------- Actions -------
    async function sendToSheetsAction() {
      const row = buildTrackerRow();
      const { ok } = await postJson({ row }); // legacy row write supported by server
      alert(ok ? "Sent to Google Sheets." : "Failed to send.");
    }

    async function createDocAction() {
      const t = computeTotals();
      const proposal = {
        company: { name: $("coName").value, phone: $("coPhone").value, email: $("coEmail").value, address: $("coAddress").value },
        client:  { name: $("clientName").value, email: $("clientEmail").value, phone: $("clientPhone").value, address: $("clientAddress").value },
        project: { title: $("projTitle").value, site: $("projSite").value, ref: $("projRef").value, validDays: $("projValid").value || 30, notes: $("notes").value, terms: $("terms").value },
        items: items.map(it => ({ name: it.name || "" })), // names only in Doc
        totals: { base: t.base, contingency: t.contingency, profit: t.profit, subtotal: t.subtotal, tax: t.tax, total: t.total }
      };
      const payload = { action: "create_proposal", proposal, trackerRow: buildTrackerRow() };
      const res = await postJson(payload);
      if (res && res.ok && res.docUrl) {
        window.open(res.docUrl, "_blank");
        alert("Google Doc created. Opening now.");
      } else {
        alert("Proposal request sent. If opened locally, check the Sheet for the Doc URL.");
      }
    }

    let CURRENT_BID_ID = null;

    async function saveBid() {
      const bid = buildBidFromForm();
      const res = await postJson({ action: "save_bid", bid, createProposalDoc: true });
      console.log("save_bid response:", res);
      if (!res || !res.ok) return alert("Save failed: " + (res && res.error ? res.error : "no response"));
      if (res.bidId) {
        CURRENT_BID_ID = res.bidId;
        try { await navigator.clipboard.writeText(res.bidId); } catch {}
        alert(`Saved.\nBID_ID = ${res.bidId}\n(The ID is copied to your clipboard.)`);
      } else {
        alert("Saved.\nThis page may be local, so the BID_ID couldn’t be read.\nOpen the Google Sheet → Bids tab → newest row for the BID_ID.\n(Use the GitHub Pages URL to see the ID immediately.)");
      }
    }

    function ensureBidItemsHeaders_() {
// Write line items (full details, backward-safe)
const itemsSh = ensureBidItemsHeaders_();
const NEWHDR = BID_ITEMS_HEADERS();

const rows = (bid.items || []).map((it, idx) => {
  const qty = Number(it?.qty || 0);
  const unit = (it?.unit || "ea").trim();
  const unitCost = Number(it?.unitCost || 0);
  const laborHours = Number(it?.laborHours || 0);
  const laborRate = Number(it?.laborRate || 65);
  let name = (it?.name || "").trim();
  if (!name && (qty || unitCost || laborHours || laborRate)) name = `Item ${idx+1}`;
  return [ bidId, idx+1, name, qty, unit, unitCost, laborHours, laborRate ];
}).filter(r => r[2] !== "" || r[3] || r[5] || r[6] || r[7]); // keep any meaningful row

if (rows.length) {
  itemsSh.getRange(itemsSh.getLastRow()+1, 1, rows.length, NEWHDR.length).setValues(rows);
}

  const headers = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0].map(String);
  // If missing any of the new columns, rewrite header row to the new schema
  const needUpgrade = NEW.some(h => !headers.includes(h)) || headers.length < NEW.length;
  if (needUpgrade) {
    sh.getRange(1,1,1,NEW.length).setValues([NEW]); // keeps existing data rows; empty cells are fine
  }
  return sh;
}
    async function loadBid() {
      const raw = $("loadBidId").value || "";
      const bidId = raw.trim();
      if (!bidId) return alert("Enter a BID_ID first (e.g., BID-20250912-1234).");

      const res = await postJson({ action: "get_bid", bidId });
      console.log("get_bid response:", res);

      if (!res || !res.ok) {
        alert("Bid not found or server blocked the request." + (res && res.error ? "\n\nDetails: " + res.error : ""));
        return;
      }

      const b = res.bid;
      CURRENT_BID_ID = b.bidId || bidId;

      // Fill fields
      $("coName").value = b.company?.name || ""; $("coPhone").value = b.company?.phone || "";
      $("coEmail").value = b.company?.email || ""; $("coAddress").value = b.company?.address || "";
      $("clientName").value = b.client?.name || ""; $("clientEmail").value = b.client?.email || "";
      $("clientPhone").value = b.client?.phone || ""; $("clientAddress").value = b.client?.address || "";
      $("projTitle").value = b.project?.title || ""; $("projSite").value = b.project?.site || "";
      $("projRef").value = b.project?.ref || ""; $("projValid").value = b.project?.validDays || 30;
      $("notes").value = b.project?.notes || ""; $("terms").value = b.project?.terms || "";

      // Items (FULL details restored)
      items = [];
      (b.items || []).forEach(it => items.push({
        id: Math.random().toString(36).slice(2),
        name: it.name || "",
        qty: it.qty ?? "",
        unit: it.unit || "ea",
        unitCost: it.unitCost ?? "",
        laborHours: it.laborHours ?? "",
        laborRate: (it.laborRate ?? 65),
      }));
      if (items.length === 0) items.push(defaultItem());
      render();
      alert(`Loaded ${CURRENT_BID_ID} (status: ${b.status}).`);
    }

    async function approveBid() {
      const bidId = CURRENT_BID_ID || $("loadBidId").value.trim();
      if (!bidId) return alert("Load a BID_ID first (or paste one).");
      const res = await postJson({ action: "approve_bid", bidId });
      if (res && res.ok) {
        alert(`Invoice created: ${res.invoiceNumber || "(see Invoices sheet)"}`);
        if (res.invoiceUrl) window.open(res.invoiceUrl, "_blank");
      } else {
        alert("Approval failed.");
      }
    }

    // Recent bids list
    function bidsCurrency(n){ return (isFinite(n)?n:0).toLocaleString(undefined,{style:"currency",currency:"USD"}); }
    async function refreshBids() {
      const res = await postJson({ action: "list_bids" }); // all statuses
      console.log("list_bids:", res);
      const host = $("bidsList");
      if (!res || !res.ok || !Array.isArray(res.rows) || res.rows.length === 0) {
        host.textContent = "No bids found yet.";
        return;
      }
      const rows = res.rows.slice(0, 20);
      const html = [
        '<table style="width:100%; border-collapse:collapse;">',
        '<thead><tr>',
          '<th style="text-align:left; border-bottom:1px solid #eee; padding:6px;">BID_ID</th>',
          '<th style="text-align:left; border-bottom:1px solid #eee; padding:6px;">Client</th>',
          '<th style="text-align:left; border-bottom:1px solid #eee; padding:6px;">Project</th>',
          '<th style="text-align:right; border-bottom:1px solid #eee; padding:6px;">Total</th>',
          '<th style="text-align:left; border-bottom:1px solid #eee; padding:6px;">Status</th>',
        '</tr></thead><tbody>'
      ];
      for (const r of rows) {
        html.push(
          `<tr class="bid-row" data-id="${r.bidId}" style="cursor:pointer;">` +
          `<td style="padding:6px; border-bottom:1px solid #f3f4f6;">${r.bidId}</td>` +
          `<td style="padding:6px; border-bottom:1px solid #f3f4f6;">${r.client || ""}</td>` +
          `<td style="padding:6px; border-bottom:1px solid #f3f4f6;">${r.project || ""}</td>` +
          `<td style="padding:6px; border-bottom:1px solid #f3f4f6; text-align:right;">${bidsCurrency(r.total||0)}</td>` +
          `<td style="padding:6px; border-bottom:1px solid #f3f4f6;">${r.status || ""}</td>` +
          `</tr>`
        );
      }
      html.push('</tbody></table>');
      host.innerHTML = html.join("");
      host.querySelectorAll(".bid-row").forEach(tr => {
        tr.addEventListener("click", () => {
          $("loadBidId").value = tr.getAttribute("data-id");
          loadBid();
        });
      });
    }

    function printNow() { window.print(); }

    // ------- Init -------
    $("addLineBtn").onclick = () => addRow();
    $("clearBtn").onclick = () => { items = []; addRow(); };
    $("sendToSheetsBtn").onclick = sendToSheetsAction;
    $("createDocBtn").onclick = createDocAction;
    $("saveBidBtn").onclick = saveBid;
    $("loadBidBtn").onclick = loadBid;
    $("approveBidBtn").onclick = approveBid;
    $("refreshBidsBtn").onclick = refreshBids;
    ["profitPct", "taxPct", "contingencyPct"].forEach((id) => {
      $(id).addEventListener("input", updateTotalsUI);
      $(id).addEventListener("change", updateTotalsUI);
    });
    addRow();
    refreshBids();
  </script>
</body>
</html>
