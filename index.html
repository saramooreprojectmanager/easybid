<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EasyBid — Contractor Bid Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; }
    h2 { margin: 24px 0 8px; }
    input, textarea, button, select { font: inherit; padding: 6px 8px; }
    input, textarea, select { border: 1px solid #ccc; border-radius: 6px; width: 100%; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; vertical-align: top; }
    th { background: #fafafa; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top: 12px; }
    .totals { border:1px solid #eee; border-radius: 8px; padding: 12px; background:#fafafa; max-width: 420px;}
    .right { text-align:right; white-space:nowrap; }
    .muted { color:#666; font-size: 12px; }
    .nowrap { white-space: nowrap; }
    .status { background:#f6f8fa; border:1px solid #e5e7eb; padding:8px 12px; border-radius:8px; margin:12px 0; font-size:12px; color:#444;}
    @media print {.no-print { display:none !important; } body { margin: 0.5in; } th { -webkit-print-color-adjust: exact; print-color-adjust: exact; }}
    label > span { font-size: 12px; color:#555; display:block; margin-bottom:4px; }

    /* Toast message styling */
    .toast {
      visibility: hidden;
      min-width: 200px;
      background: #333;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 10px 16px;
      position: fixed;
      z-index: 1000;
      left: 50%;
      bottom: 40px;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.4s, bottom 0.4s;
      font-size: 14px;
    }
    .toast.show { visibility: visible; opacity: 1; bottom: 60px; }
  </style>
</head>
<body>
  <h1>EasyBid — Contractor Bid Tool</h1>
  <div class="muted">Add items, set markup, send to Google Sheets, and generate a Google Doc proposal. You can also save/load a draft locally.</div>

  <div id="urlStatus" class="status no-print">Web App URL: <em>(not set)</em></div>

  <h2>Company</h2>
  <div class="grid-2">
    <label><span>Company name</span><input id="coName" value="Moore Builder & Sons" /></label>
    <label><span>Phone</span><input id="coPhone" value="505-252-0930" /></label>
  </div>
  <div class="grid-2">
    <label><span>Email</span><input id="coEmail" value="moorebuilderandsons@gmail.com" /></label>
    <label><span>License #</span><input id="coLicense" value="Pending" /></label>
  </div>
  <label><span>Address</span><input id="coAddress" value="Placitas, NM 87043" style="margin-bottom:8px;" /></label>

  <h2>Client</h2>
  <div class="grid-2">
    <label><span>Client name</span><input id="clientName" /></label>
    <label><span>Client email</span><input id="clientEmail" /></label>
  </div>
  <div class="grid-2">
    <label><span>Client phone</span><input id="clientPhone" /></label>
    <label><span>Client address</span><input id="clientAddress" /></label>
  </div>

  <h2>Project</h2>
  <div class="grid-2">
    <label><span>Project title</span><input id="projTitle" value="Untitled Bid" /></label>
    <label><span>Reference #</span><input id="projRef" /></label>
  </div>
  <div class="grid-2">
    <label><span>Site address</span><input id="projSite" /></label>
    <label><span>Valid (days)</span><input id="projValid" type="number" value="30" /></label>
  </div>

  <h2>Line Items</h2>
  <table id="itemsTable">
    <thead>
      <tr>
        <th style="width:24%">Name</th>
        <th class="nowrap">Qty</th>
        <th class="nowrap">Unit</th>
        <th class="nowrap">Unit Cost</th>
        <th class="nowrap">Labor Hrs</th>
        <th class="nowrap">Labor Rate</th>
        <th class="right nowrap">Material $</th>
        <th class="right nowrap">Labor $</th>
        <th class="no-print"></th>
      </tr>
    </thead>
    <tbody id="itemsBody"></tbody>
  </table>
  <div class="actions no-print">
    <button id="addLineBtn">Add line</button>
    <button id="clearBtn">Clear all</button>
  </div>

  <h2>Markup</h2>
  <div class="grid-4" style="max-width:900px">
    <label><span>Profit %</span><input id="profitPct" type="number" inputmode="decimal" value="20" /></label>
    <label><span>Tax %</span><input id="taxPct" type="number" inputmode="decimal" value="7.625" /></label>
    <label><span>Tax $ (auto)</span><input id="taxDollars" disabled /></label>
    <label><span>Contingency %</span><input id="contingencyPct" type="number" inputmode="decimal" value="5" /></label>
  </div>

  <h2>Notes</h2>
  <textarea id="notes" rows="4"></textarea>

  <h2>Terms</h2>
  <textarea id="terms" rows="3">Payment terms: 50% deposit to schedule, balance upon substantial completion. Prices valid for 30 days.</textarea>

  <h2>Drafts</h2>
  <div class="grid-2" style="max-width:760px">
    <label><span>Draft name (for saving multiple versions)</span><input id="draftName" placeholder="e.g., Smith Kitchen v1" /></label>
    <label><span>Saved drafts</span>
      <select id="draftSelect"></select>
    </label>
  </div>
  <div class="actions no-print">
    <button id="saveAsBtn">Save As</button>
    <button id="loadSelectedBtn">Load Selected</button>
    <button id="deleteSelectedBtn">Delete Selected</button>
  </div>

  <h2>Totals</h2>
  <div class="totals">
    <div>Materials: <span id="matTotal" class="right"></span></div>
    <div>Labor: <span id="labTotal" class="right"></span></div>
    <div>Base: <span id="baseTotal" class="right"></span></div>
    <div>Contingency: <span id="contTotal" class="right"></span></div>
    <div>Profit: <span id="profitTotal" class="right"></span></div>
    <div>Tax: <span id="taxTotal" class="right"></span></div>
    <div style="border-top:1px solid #ddd; margin:8px 0;"></div>
    <div><strong>Total: <span id="grandTotal" class="right"></span></strong></div>
  </div>

  <div class="actions no-print" style="margin-top:16px;">
    <button id="saveDraftBtn">Save Draft</button>
    <button id="loadDraftBtn">Load Draft</button>
    <button id="newDraftBtn">New / Clear</button>
    <button id="sendToSheetsBtn">Send to Google Sheets</button>
    <button id="createDocBtn">Create Google Doc Proposal</button>
    <button id="printBtn">Print / Save PDF</button>
  </div>

    <button id="saveDraftBtn">Save Draft</button>
    <button id="loadDraftBtn">Load Draft</button>
    <button id="newDraftBtn">New / Clear</button>
    <button id="sendToSheetsBtn">Send to Google Sheets</button>
    <button id="createDocBtn">Create Google Doc Proposal</button>
    <button id="printBtn">Print / Save PDF</button>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ====== CONFIG ======
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxGoKZj6FSdeonBad9o1VOCLTxH_eKKaWoxSSVj38WGLMZn-yTybIqWqNxIlpCPUeo9/exec"; // <-- replace with your Apps Script /exec URL

    // ====== TOAST ======
    function showToast(msg, timeout = 2000) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.className = "toast show";
      setTimeout(() => { toast.className = toast.className.replace("show", ""); }, timeout);
    }

    // ====== STATUS BANNER ======
    (function showCurrentUrl(){
      const el = document.getElementById("urlStatus");
      el.innerHTML = "Web App URL: <code>" + (WEB_APP_URL || "(not set)") + "</code>";
      console.log("WEB_APP_URL =", WEB_APP_URL);
    })();

    // ====== HELPERS ======
    function isValidAppsScriptUrl(u){
      if (typeof u !== "string") return false;
      const s = u.trim();
      // Allow both /exec and /dev so testing URLs don't get blocked
      return /^https:\/\/script\.google\.com\/macros\/s\/[^\/]+\/(exec|dev)(\?.*)?$/.test(s);
    }
    const $ = (id)=>document.getElementById(id);
    const currency=(n)=>(isFinite(n)?n:0).toLocaleString(undefined,{style:"currency",currency:"USD"});
    const num=(v)=>(v===""||v==null?0:Number(v));

    // ====== LINE ITEMS ======
    let items = [];
    function defaultItem(){ return { id: Math.random().toString(36).slice(2), name:"", qty:"", unit:"ea", unitCost:"", laborHours:"", laborRate:"70" }; }
    function addRow(it = defaultItem()){ items.push(it); render(); }
    function removeRow(id){ items = items.filter(x => x.id !== id); render(); }

    function render(){
      const tbody = $("itemsBody");
      tbody.innerHTML = "";

      items.forEach((it) => {
        const tr = document.createElement("tr");

        const tdMat = document.createElement("td"); tdMat.className = "right";
        const tdLab = document.createElement("td"); tdLab.className = "right";
        const updateRowComputed = () => {
          tdMat.textContent = currency(num(it.qty) * num(it.unitCost));
          tdLab.textContent = currency(num(it.laborHours) * num(it.laborRate));
        };

        const makeCellInput = (prop, opts = {}) => {
          const td = document.createElement("td");
          const input = document.createElement("input");
          if (opts.type) input.type = opts.type;
          if (opts.step) input.setAttribute("step", opts.step);
          input.value = it[prop] ?? "";
          input.oninput = (e) => { it[prop] = e.target.value; updateRowComputed(); updateTotalsUI(); };
          td.appendChild(input);
          return td;
        };

        const tdName     = makeCellInput("name");
        const tdQty      = makeCellInput("qty",        { type:"number", step:"any" });
        const tdUnit     = makeCellInput("unit");
        const tdUnitCost = makeCellInput("unitCost",   { type:"number", step:"any" });
        const tdLaborH   = makeCellInput("laborHours", { type:"number", step:"any" });
        const tdLaborR   = makeCellInput("laborRate",  { type:"number", step:"any" });

        const tdDel = document.createElement("td"); tdDel.className = "no-print";
        const delBtn = document.createElement("button"); delBtn.textContent = "✕"; delBtn.onclick = () => removeRow(it.id);
        tdDel.appendChild(delBtn);

        updateRowComputed();
        [tdName, tdQty, tdUnit, tdUnitCost, tdLaborH, tdLaborR, tdMat, tdLab, tdDel].forEach(td => tr.appendChild(td));
        tbody.appendChild(tr);
      });

      updateTotalsUI();
    }

    // ====== TOTALS ======
    function computeTotals(){
      const material = items.reduce((s,it)=> s + num(it.qty)*num(it.unitCost), 0);
      const labor    = items.reduce((s,it)=> s + num(it.laborHours)*num(it.laborRate), 0);
      const base     = material + labor;
      const cPct = num($("contingencyPct").value);
      const pPct = num($("profitPct").value);
      const tPct = num($("taxPct").value);
      const contingency = (cPct/100) * base;
      const profit      = (pPct/100) * (base + contingency);
      const subtotal    = base + contingency + profit;
      const tax         = (tPct/100) * subtotal;
      const total       = subtotal + tax;
      return { material, labor, base, contingency, profit, subtotal, tax, total };
    }

    function updateTotalsUI(){
      const t = computeTotals();
      $("matTotal").textContent    = currency(t.material);
      $("labTotal").textContent    = currency(t.labor);
      $("baseTotal").textContent   = currency(t.base);
      $("contTotal").textContent   = currency(t.contingency);
      $("profitTotal").textContent = currency(t.profit);
      $("taxTotal").textContent    = currency(t.tax);
      $("taxDollars").value        = currency(t.tax);
      $("grandTotal").textContent  = currency(t.total);
    }

    // ====== SHEETS & DOC ======
    function buildTrackerRow(){
      const t = computeTotals();
      return [
        new Date().toISOString(),
        $("projTitle").value,
        $("clientName").value,
        $("clientEmail").value,
        $("clientPhone").value,
        $("projSite").value,
        $("projRef").value,
        $("projValid").value || 30,
        t.material.toFixed(2),
        t.labor.toFixed(2),
        t.base.toFixed(2),
        0, "0.00",
        Number($("contingencyPct").value || 0), t.contingency.toFixed(2),
        Number($("profitPct").value || 0), t.profit.toFixed(2),
        Number($("taxPct").value || 0), t.tax.toFixed(2),
        t.total.toFixed(2),
        items.length
      ];
    }

    function buildProposal(){
      const t = computeTotals();
      return {
        company: { name: $("coName").value, phone: $("coPhone").value, email: $("coEmail").value, address: $("coAddress").value, license: $("coLicense").value },
        client:  { name: $("clientName").value, email: $("clientEmail").value, phone: $("clientPhone").value, address: $("clientAddress").value },
        project: { title: $("projTitle").value, site: $("projSite").value, ref: $("projRef").value, validDays: $("projValid").value || 30, notes: $("notes").value, terms: $("terms").value },
        items: items.map(it => ({ name: it.name || "" })),
        totals: { subtotal: t.subtotal, tax: t.tax, total: t.total }
      };
    }

    function sendToGoogleSheet(row){
      if (!isValidAppsScriptUrl(WEB_APP_URL)) { showToast("Bad /exec URL ❌"); return; }
      const payload = JSON.stringify({ action: "append_tracker_row", row });
      // Try CORS-friendly POST first to catch server errors
      fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: payload,
        redirect: "follow",
      })
      .then(async (res) => {
        const text = await res.text();
        let json = {}; try { json = JSON.parse(text); } catch {}
        if (res.ok && json.ok) {
          showToast("Sent to Sheets ✅");
        } else {
          console.warn("Sheets POST response:", res.status, text);
          // Fallback to no-cors for legacy handlers that don't return JSON
          try {
            if (navigator.sendBeacon) {
              navigator.sendBeacon(WEB_APP_URL, new Blob([JSON.stringify({ row })], { type: "text/plain;charset=UTF-8" }));
              showToast("Sent to Sheets (fallback) ✅");
            } else {
              fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ row }) });
              showToast("Sent to Sheets (fallback) ✅");
            }
          } catch (e) {
            showToast("Send failed ❌");
          }
        }
      })
      .catch(err => { console.error(err); showToast("Network error ❌"); });
    }

    async function createDocAction(){
      if (!isValidAppsScriptUrl(WEB_APP_URL)) { showToast("Bad /exec URL ❌"); return; }
      const payload = JSON.stringify({ action: "create_proposal", proposal: buildProposal(), trackerRow: buildTrackerRow() });
      try {
        const r = await fetch(WEB_APP_URL, { method: "POST", headers: {"Content-Type":"application/json"}, body: payload });
        const t = await r.text();
        let j={}; try { j = JSON.parse(t); } catch {}
        if (r.ok && j.ok && j.docUrl) { window.open(j.docUrl, "_blank"); showToast("Google Doc created ✅"); }
        else { console.warn("Doc response:", r.status, t); showToast("Doc creation failed ❌"); }
      } catch { showToast("Could not reach Apps Script ❌"); }
    }(){
      if (!isValidAppsScriptUrl(WEB_APP_URL)) { showToast("Bad /exec URL ❌"); return; }
      const payload = JSON.stringify({ action: "create_proposal", proposal: buildProposal(), trackerRow: buildTrackerRow() });
      try {
        const r = await fetch(WEB_APP_URL, { method: "POST", body: payload });
        const t = await r.text();
        const j = JSON.parse(t || "{}");
        if (j.ok && j.docUrl) { window.open(j.docUrl, "_blank"); showToast("Google Doc created ✅"); }
        else { showToast("Doc creation failed ❌"); }
      } catch {
        showToast("Could not reach Apps Script ❌");
      }
    }

    // ====== SAVE/LOAD DRAFT ======
    const DRAFTS_KEY = "easybid_drafts_v1"; // name -> draft object
const LAST_KEY = "easybid_last_draft_name";

function currentDraftName(){ return (document.getElementById("draftName").value || "").trim(); }
function loadDraftsMap(){ try { return JSON.parse(localStorage.getItem(DRAFTS_KEY) || "{}"); } catch { return {}; } }
function saveDraftsMap(map){ localStorage.setItem(DRAFTS_KEY, JSON.stringify(map)); }
function refreshDraftSelect(selectName){
  const map = loadDraftsMap();
  const sel = document.getElementById("draftSelect");
  sel.innerHTML = "";
  const ph = document.createElement("option"); ph.value = ""; ph.textContent = "— select a saved draft —"; sel.appendChild(ph);
  Object.keys(map).sort().forEach(name=>{ const o=document.createElement("option"); o.value=name; o.textContent=name; if(selectName && selectName===name) o.selected=true; sel.appendChild(o); });
}

function collectDraft(){
  return {
    company: { name: $("coName").value, phone: $("coPhone").value, email: $("coEmail").value, license: $("coLicense").value, address: $("coAddress").value },
    client:  { name: $("clientName").value, email: $("clientEmail").value, phone: $("clientPhone").value, address: $("clientAddress").value },
    project: { title: $("projTitle").value, ref: $("projRef").value, site: $("projSite").value, validDays: $("projValid").value },
    notes: $("notes").value,
    terms: $("terms").value,
    items
  };
}

function applyDraft(d){
  $("coName").value = d.company?.name || "";
  $("coPhone").value = d.company?.phone || "";
  $("coEmail").value = d.company?.email || "";
  $("coLicense").value = d.company?.license || "";
  $("coAddress").value = d.company?.address || "";
  $("clientName").value = d.client?.name || "";
  $("clientEmail").value = d.client?.email || "";
  $("clientPhone").value = d.client?.phone || "";
  $("clientAddress").value = d.client?.address || "";
  $("projTitle").value = d.project?.title || "";
  $("projRef").value = d.project?.ref || "";
  $("projSite").value = d.project?.site || "";
  $("projValid").value = d.project?.validDays || 30;
  $("notes").value = d.notes || "";
  $("terms").value = d.terms || "";
  items = Array.isArray(d.items) ? d.items : [];
  if (items.length === 0) items.push(defaultItem());
  render();
}

// Single-click quick save/load for convenience
function saveDraft(){
  const name = currentDraftName() || ( $("projTitle").value ? $("projTitle").value.trim() : "Untitled" );
  const map = loadDraftsMap();
  map[name] = collectDraft();
  saveDraftsMap(map);
  localStorage.setItem(LAST_KEY, name);
  refreshDraftSelect(name);
  showToast(`Saved: ${name} ✅`);
}
function loadDraft(){
  const map = loadDraftsMap();
  const last = localStorage.getItem(LAST_KEY) || "";
  if (!last || !map[last]) { showToast("No saved draft ❌"); return; }
  document.getElementById("draftName").value = last;
  applyDraft(map[last]);
  showToast(`Loaded: ${last} ✅`);
}
function newDraft(){
  items = []; addRow();
  $("notes").value = "";
  $("terms").value = "Payment terms: 50% deposit to schedule, balance upon substantial completion. Prices valid for 30 days.";
  showToast("New draft ready");
}

// Multi-draft controls
document.addEventListener("DOMContentLoaded", ()=>{
  refreshDraftSelect(localStorage.getItem(LAST_KEY) || "");
  const sel = document.getElementById("draftSelect");
  sel.addEventListener("change", ()=>{ document.getElementById("draftName").value = sel.value; });
});

document.getElementById("saveAsBtn").addEventListener("click", ()=>{
  const name = currentDraftName();
  if (!name) return showToast("Enter a draft name ❌");
  const map = loadDraftsMap();
  map[name] = collectDraft();
  saveDraftsMap(map);
  localStorage.setItem(LAST_KEY, name);
  refreshDraftSelect(name);
  showToast(`Saved: ${name} ✅`);
});

document.getElementById("loadSelectedBtn").addEventListener("click", ()=>{
  const sel = document.getElementById("draftSelect");
  const name = sel.value;
  if (!name) return showToast("Choose a saved draft ❌");
  const map = loadDraftsMap();
  if (!map[name]) return showToast("Draft not found ❌");
  document.getElementById("draftName").value = name;
  applyDraft(map[name]);
  localStorage.setItem(LAST_KEY, name);
  showToast(`Loaded: ${name} ✅`);
});

document.getElementById("deleteSelectedBtn").addEventListener("click", ()=>{
  const sel = document.getElementById("draftSelect");
  const name = sel.value;
  if (!name) return showToast("Choose a saved draft ❌");
  const map = loadDraftsMap();
  if (!map[name]) return showToast("Draft not found ❌");
  delete map[name];
  saveDraftsMap(map);
  if (localStorage.getItem(LAST_KEY) === name) localStorage.removeItem(LAST_KEY);
  refreshDraftSelect("");
  document.getElementById("draftName").value = "";
  showToast(`Deleted: ${name} ✅`);
});

// ====== WIRE UP UI ======
    $("addLineBtn").onclick = () => addRow();
    $("clearBtn").onclick = () => { items = []; addRow(); };
    $("sendToSheetsBtn").onclick = () => {
    const row = buildTrackerRow();
    console.log("Sending tracker row:", row);
    sendToGoogleSheet(row);
  };
    $("createDocBtn").onclick = createDocAction;
    $("printBtn").onclick = () => window.print();
    $("saveDraftBtn").onclick = saveDraft;
    $("loadDraftBtn").onclick = loadDraft;
    $("newDraftBtn").onclick = newDraft;
    ["profitPct","taxPct","contingencyPct"].forEach(id => { $(id).addEventListener("input", updateTotalsUI); $(id).addEventListener("change", updateTotalsUI); });

    // ====== INIT ======
    addRow(); // ensure one starting line item row
  </script>
</body>
</html>
